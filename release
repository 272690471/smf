#!/bin/bash
set -e
git_root=$(git rev-parse --show-toplevel)

source .common_build.sh

build_dir=$git_root/build_release
mkdir -p $build_dir
cd $build_dir


echo "./release quick"
echo "To build and run tests only, no formatting, validation, etc"

if [[ $1 != "quick" ]]; then
    echo "Generating version file"
    $git_root/misc/version.sh
    cat $git_root/src/version.h
    echo "Formatting files"
    $git_root/misc/fmt.py
fi

cmake --graphviz=$build_dir/dependencies.dot \
      -Wno-dev \
      -DCMAKE_VERBOSE_MAKEFILE=ON -G Ninja \
      -DCMAKE_BUILD_TYPE=Release $git_root

# for fmt.py
ln -sfn "$build_dir/compile_commands.json" "$git_root/compile_commands.json"


#produce documentation
if [[ $1 != "quick" ]]; then
    cmake --build $build_dir --target doc
fi

# from .common_build.sh
$ninja_cmd

ctest -V -j$nprocs --force-new-ctest-process
